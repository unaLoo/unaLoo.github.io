---
title: '浏览器环境概述'
date: 2025-07-31
tags:
  - JavaScript
---

# 浏览器环境概述

浏览器**内置**了 JS 引擎，并提供了一系列接口，以供网页中的 JS 脚本可以控制浏览器的各种功能。

## 嵌入 JS 到网页的方法
- `script` 标签 , 直接嵌入代码或通过 src 属性加载外部脚本, 
  - 又有内嵌代码，又有 src 属性时，浏览器会加载外部脚本，忽略内部代码。  
- 事件属性，元素的的事件可以直接写 JS 代码
- URL 协议 `javascript:` 也是一种协议 ```<a href="javascript: void(submit())">文字</a>```


## script 元素

通常，**网页加载的流程**如下：
1. 浏览器下载 HTML 并解析
2. 如果遇到 `<script>` 元素，就暂停解析，把控制权交给 JS 引擎
3. 如果 script 标签指向外部脚本，那么下载外部脚本再执行，否则直接执行代码
4. JS 引擎执行完毕，控制权还给渲染引擎，继续解析 HTML


由于 JS 代码可以修改 DOM，所以需要等待 JS 下载并执行之后才恢复 HTML 解析，如果外部脚本一直未能下载下来，网页就会进入**假死**状态，长时间无响应。


所以，script 标签通常放在**底部**，才可以访问现有的 DOM 元素。当然，把逻辑放在`DOMContentLoaded`事件里也是一种方法。


当 HTML 中有多个 script 时，浏览器会同时下载多个 js 文件，但**执行顺序**由 HTML 中的顺序**一致**，只有这样，才保证了脚本间依赖关系不被破坏。

### defer 属性

```html
<script src="a.js"></script>
<script src="b.js" defer></script>
```

由于 JS 会阻塞 HTML 解析，即解析 DOM 树的构建，所以出现了 `defer` 属性，遇到 defer 属性的script，网页加载的行为如下：
1. 下载并解析 HTML
2. 遇到 defer 属性的 JS 脚本b，并行下载，同时继续往下解析 HTML
3. 解析完 HTML，DOM树构建完毕后，执行脚本b
4. 然后才触发 `DOMContentLoaded` 事件

经测试，如果不加 `defer`，那么：
- 先出现 `hello`
- 等待 deferScript.js 加载完毕，打印 `deferScript Call !`，再打印 `small call!`
- 再渲染 `what` (很快)
- 再打印 `DOMContentLoaded !!` 
也就是 script 堵塞 HTML 解析了

如果加`defer`，那么：
- `hello`  `what` 基本同时出来，但是标签页还在转圈
- 脚本加载完毕后，打印`deferScript Call ! ，再打印 `small call!
- 再打印 `DOMContentLoaded !!` 
也就是没有堵塞 HTML 解析，且多个 defer 脚本执行顺序按照文档顺序，但是要注意 `DOMContentLoaded` 是在脚本加载完毕后才触发的。

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
        document.addEventListener('DOMContentLoaded', (e) => {
            console.log('DOMContentLoaded !!!', e)
        })
    </script>
</head>
<body>
    <h1>hello</h1>
    <script src="./deferScript.js"></script>
	<script defer src="./small.js"></script>
    <h2>waht ?</h2>
</body>
</html>
```


### async 属性

`async` 属性也是解决堵塞问题的一个方法，不堵塞 HTML 解析，在解析HTML的同时并行下载脚本，一旦下载完毕，暂停解析并执行脚本。


显然，与`defer`相比，带`async`属性的脚本执行顺序不确定，体量小，下载速度快的脚本会得到优先执行。

所以，一般来说，如果脚本间没有依赖关系，就 `async`，有依赖关系的话，就 `defer` 


### defer 和 async 的应用场景

1. 使用 CDN 引入第三方库时，就应该使用 `defer` 保证项目入口脚本文件在第三方库脚本之后。
2. 用户行为埋点，比如`Google Analytics`，这种独立的脚本就可以`async`，比如我博客中的这个埋点。
![[../../public/post-assets/Pasted image 20250801165439.png]]



**域名分片：**   
此外，浏览器对**同一个域名**的**并发资源下载**数量是有**限制**的，所以网站通常会把资源分布到多个子域名，以突破这个限制、提高加载速度。



## 补充：CSS 是否阻塞页面加载渲染嘞？
对于外部的 CSS 文件，CSS **不阻塞 DOM 树解析**，但是**会堵塞 DOM 树渲染**。 

```html
<!DOCTYPE html>
<html lang="en">

<head>
    <title>css阻塞</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        h1 {
            color: rgb(0, 255, 0);
        }
    </style>

    <script>
        setTimeout(() => {
            console.log('head script', document.querySelector('#hh').textContent)
        }, 1);
    </script>
    <link href="https://cdn.bootcss.com/bootstrap/4.0.0-alpha.6/css/bootstrap.css" rel="stylesheet">
</head>

<body>
    <h1 id="hh">hhhh</h1>
    <script>
        console.log('body script', document.querySelector('#hh').textContent)
    </script>
</body>

</html>
```




