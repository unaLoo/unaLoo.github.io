---
title: 'JavaScript Promise'
date: 2025-06-10
permalink: /posts/promise/
tags:
  - JavaScript
  - é¢è¯•é¢˜
---

> Promise æ˜¯ JavaScript ä¸­å¤„ç†å¼‚æ­¥æ“ä½œçš„ä¸€ç§æœºåˆ¶ï¼Œå®ƒæä¾›äº†ä¸€ç§æ›´ä¼˜é›…ã€æ›´ç›´è§‚çš„æ–¹å¼æ¥å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼Œé¿å…äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ Promise çš„åŸç†ã€å¸¸ç”¨APIåŠå…¶åº”ç”¨åœºæ™¯ä»¥åŠä¸äº‹ä»¶å¾ªç¯çš„å…³ç³»ã€‚

----

## ç›®å½•

- [ä¸€ã€ç®€å•å›é¡¾ Promise](#ä¸€ç®€å•å›é¡¾-promise)
- [äºŒã€Promise : ä½¿ç”¨](#äºŒpromise--ä½¿ç”¨)
- [ä¸‰ã€Promiseæ‰‹å†™](#ä¸‰promiseæ‰‹å†™)



## ä¸€ã€ç®€å•å›é¡¾ [Promise](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)

Promise æ˜¯ JavaScript ä¸­ç”¨äºè¡¨ç¤º**å¼‚æ­¥æ“ä½œæœ€ç»ˆå®Œæˆæˆ–å¤±è´¥**åŠå…¶**ç»“æœå€¼**çš„å¯¹è±¡ã€‚

ä»¥ä¸‹å°†å…¶ç‰¹æ€§æ€»ç»“ä¸ºå››ä¸ªï¼šä¸‰ç§çŠ¶æ€ã€é“¾å¼è°ƒç”¨ã€å¾®ä»»åŠ¡ã€async/awaitã€‚
 
### ä¸‰ç§çŠ¶æ€
- Promise ä»£è¡¨ä¸€ä¸ªåˆ›å»ºæ—¶æœªçŸ¥ï¼Œ**æœªæ¥æ‰ä¼šç»“æŸ**çš„æ“ä½œç»“æœã€‚
- Promise åŸºäºä¸‰ç§çŠ¶æ€ï¼š`pending`ã€`fulfilled`ã€`rejected`ã€‚å¯ä»¥ä¸º Promise æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œåœ¨æ“ä½œå®Œæˆæˆ–å¤±è´¥æ—¶æ‰§è¡Œã€‚

### é“¾å¼è°ƒç”¨ï¼ˆPromise chainingï¼‰
- é“¾å¼è°ƒç”¨å¯ä»¥é¿å…å›è°ƒåœ°ç‹±ï¼ˆcallback hellï¼‰çš„é—®é¢˜ï¼Œä½¿ä»£ç æ›´æ¸…æ™°æ˜“è¯»ã€‚
   
- è¿ç»­çš„ .then() è°ƒç”¨å°±åƒä¸€ä¸ªâ€œæ•°æ®ç®¡é“â€ï¼Œå‰ä¸€ä¸ª .then() çš„è¿”å›å€¼ä¼šä¼ é€’ç»™ä¸‹ä¸€ä¸ª .then()ã€‚

- å¦‚æœä¸Šä¸€ä¸ª .then() è¿”å›çš„æ˜¯ä¸€ä¸ª Promiseï¼Œä¸‹ä¸€ä¸ª .then() ä¼šç­‰å¾…è¿™ä¸ª Promise å¼‚æ­¥å®Œæˆï¼Œå†ç»§ç»­æ‰§è¡Œã€‚
  
- å¦‚æœä¸Šä¸€ä¸ª .then() è¿”å›çš„æ˜¯ä¸€ä¸ª æ™®é€šå€¼ï¼ˆé Promiseï¼‰ï¼Œä¸‹ä¸€ä¸ª .then() ä¼š ç«‹å³æŠŠè¯¥å€¼å°è£…ä¸º Promise.resolve(...)ï¼Œç„¶å**è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œ** â€”â€” ä¸æ˜¯åŒæ­¥æ‰§è¡Œ â—ï¸

- å¦‚æœä¸Šä¸€ä¸ª .then() æŠ›å‡ºå¼‚å¸¸æˆ–è¿”å›çš„æ˜¯ Promise.reject(...)ï¼Œåˆ™ä¸‹ä¸€ä¸ª .then() ä¸ä¼šæ‰§è¡Œï¼Œè€Œä¼šè¿›å…¥ä¸‹ä¸€ä¸ª .catch() æˆ– .then(undefined, onRejected)ã€‚

- æ¯ä¸ª .then() éƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå³ä½¿å‰ä¸€ä¸ª .then() æ˜¯ç«‹å³è¿”å›æ™®é€šå€¼ã€‚


### å¾®ä»»åŠ¡ï¼ˆMicrotaskï¼‰

Promise çš„å›è°ƒï¼ˆthen/catch/finallyï¼‰ä¼šåœ¨**å¾®ä»»åŠ¡é˜Ÿåˆ—**ï¼ˆmicrotask queueï¼‰ä¸­æ‰§è¡Œï¼Œä¼˜å…ˆäº setTimeout ç­‰å®ä»»åŠ¡ã€‚

```js
  console.log('start');
  Promise.resolve().then(() => console.log('promise'));
  setTimeout(() => console.log('timeout'));
  console.log('end');
  // start â†’ end â†’ promise â†’ timeout
```

### async/await

`async/await` æ˜¯ Promise çš„è¯­æ³•ç³– + æ§åˆ¶æµæ”¹è¿›ï¼Œä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ï¼Œæå‡å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

```js

  async function demo() {
    const x = await fetchSomeData();
    console.log(x);
  }

  function demo(){
    return new Promise((resolve, reject) => {
      fetchSomeData().then(x => {
        console.log(x);
        resolve();
      })
    })
  }

  function demo() {
    return Promise.resolve().then(() => {
      return fetchSomeData();
    }).then(x => {
      console.log(x);
    });
  }
```







## äºŒã€Promise : ä½¿ç”¨

#### 1. PromiseåŸºæœ¬ä½¿ç”¨

```js
  // åˆ›å»º
  const promise = new Promise((resolve, reject) => {
    // å¼‚æ­¥æ“ä½œ
    if (/* æˆåŠŸ */) {
      resolve(value); // å˜ä¸º fulfilled
    } else {
      reject(error); // å˜ä¸º rejected
    }
  });

  // ä½¿ç”¨
  promise
    .then(result => {
      // æˆåŠŸæ—¶æ‰§è¡Œ
      // thenä¹Ÿå¯ä»¥æœ‰ç¬¬äºŒä¸ªå‚æ•° onRejectedï¼Œç”¨äºå¤„ç†å¤±è´¥
    })
    .catch(error => {
      // å¤±è´¥æ—¶æ‰§è¡Œ
    })
    .finally(() => {
      // æ€»ä¼šæ‰§è¡Œ
    });
```
---


```js
  // åŠ è½½å›¾ç‰‡
  function imgLoad(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
      img.src = url;
    });
  }

  imgLoad('https://example.com/image.png')
    .then(img => {
      document.body.appendChild(img);
    })
    .catch(error => {
      console.error(error);
    });
```
   
#### 2. å¸¸ç”¨é™æ€æ–¹æ³•

**`Promise.resolve(value)`**ï¼šè¿”å›ä¸€ä¸ªfulfilledçš„ Promiseï¼ŒåŸºæœ¬ç­‰ä»·äº `new Promise(resolve => resolve(value))`

åº”ç”¨åœºæ™¯ï¼š
- å°†æ™®é€šå€¼è½¬æ¢ä¸º Promise
- ç»Ÿä¸€è¿”å› Promise å¯¹è±¡

æˆ‘è‡ªå·±é€šå¸¸ä¼šç–‘æƒ‘ï¼š`Promise.resolve(1)` å’Œ `new Promise(resolve => resolve(1))` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
> ä¸¤è€…æœ€ç»ˆéƒ½ä¼šè¿”å›ä¸€ä¸ªçŠ¶æ€ä¸º fulfilledï¼ˆå·²å…‘ç°ï¼‰ã€å€¼ä¸º 1 çš„ Promise å¯¹è±¡
> ä½† `Promise.resolve(1)` æ˜¯ç«‹å³åˆ›å»ºä¸€ä¸ªå·²å®Œæˆçš„Promiseå¹¶æ”¾å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—
> è€Œ `new Promise(resolve => resolve(1))` æ˜¯å…ˆåŒæ­¥æ‰§è¡Œæ„é€ å‡½æ•°ä½“ï¼Œå†è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—

```js
  console.log('A');
  Promise.resolve(1).then(() => console.log('B'));
  new Promise(resolve => {
    console.log('C');
    resolve(1);
  }).then(() => console.log('D'));
  console.log('E');
  // A â†’ C â†’ E â†’ B â†’ D
```

---

**`Promise.all([p1, p2, ...])`**ï¼šå…¨éƒ¨æˆåŠŸæ‰æˆåŠŸï¼Œæœ‰ä¸€ä¸ªå¤±è´¥å°±å¤±è´¥

åº”ç”¨åœºæ™¯ï¼š 
- åˆå¹¶å¤šä¸ª Promise ç»“æœ
- å¹¶å‘è¯·æ±‚å¤šä¸ªæ¥å£

  ```js
    Promise.all([
      fetch('/user'),
      fetch('/comments'),
      fetch('/likes')
    ])
      .then(([userRes, commentRes, likeRes]) => {
        // do something
      })
  ```

---


**`Promise.race([p1, p2, ...])`**ï¼šç¬¬ä¸€ä¸ªå®Œæˆï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰å°±è¿”å›

åº”ç”¨åœºæ™¯
- è¶…æ—¶å¤„ç†
- å¤šä¸ªæ¥å£è¯·æ±‚ç«é€Ÿï¼ˆè¿™æœ‰å•¥åœºæ™¯ï¼Ÿï¼‰

  ```js
  // è¶…æ—¶å¤„ç†
  Promise.race([
    fetch('/user'),
    new Promise((_, reject) => setTimeout(() => reject(new Error('è¶…æ—¶')), 1000))
  ]).then(userRes => {
    // do something
  }).catch(error => {
    // handle timeout
  });
  ```

---
**`Promise.allSettled([p1, p2, ...])`**ï¼šå…¨éƒ¨ç»“æŸåè¿”å›æ¯ä¸ªç»“æœ

åº”ç”¨åœºæ™¯
- éƒ¨åˆ†å¤±è´¥ä¹Ÿå¯æ¥å—, æ¯”å¦‚æ‰¹é‡ä¸Šä¼ ï¼Œä¸èƒ½å› ä¸ºä¸€ä¸ªå¤±è´¥å°±å…¨éƒ¨å¤±è´¥
  ```js
    const uploadFiles = files.map(file => uploadFile(file)); // æ¯ä¸ªæ˜¯ä¸€ä¸ª Promise

    Promise.allSettled(uploadFiles).then(results => {
      const successes = results.filter(r => r.status === 'fulfilled');
      const failures = results.filter(r => r.status === 'rejected');

      console.log('æˆåŠŸçš„æ–‡ä»¶ï¼š', successes.map(r => r.value));
      console.warn('å¤±è´¥çš„æ–‡ä»¶ï¼š', failures.map(r => r.reason));
    });
  ```

- å¯¹å¤šä¸ªè¦ç´ è¿›è¡Œå¹¶è¡Œçš„æ¨¡å‹è®¡ç®—ï¼ŒæˆåŠŸçš„ç»“æœç•™ä¸‹ï¼Œå¤±è´¥çš„é‡è¯•
  ```js
    const modelTasks = features.map(feature => runModel(feature));
    Promise.allSettled(modelTasks).then(results => {
      const successes = results.filter(r => r.status === 'fulfilled');
      const failures = results.filter(r => r.status === 'rejected');

      console.log('æˆåŠŸçš„ä»»åŠ¡ï¼š', successes.map(r => r.value));
      console.warn('å¤±è´¥çš„ä»»åŠ¡ï¼š', failures.map(r => r.reason));
      // é‡è¯•å¤±è´¥çš„ä»»åŠ¡
    });
  ```


---
**`Promise.any([p1, p2, ...])`**ï¼šæœ‰ä¸€ä¸ªæˆåŠŸå°±æˆåŠŸï¼Œå…¨éƒ¨å¤±è´¥æ‰å¤±è´¥

åº”ç”¨åœºæ™¯
- å¤šä¸ªæ¥å£è¿”å›çš„ç»“æœéƒ½OKï¼Œç”¨æœ€å¿«fulfilledçš„é‚£ä¸ªå³å¯ï¼ˆCDNå¤‡ä»½è¯·æ±‚ï¼‰

  ```js
    Promise.any([
      fetch('https://cdn1.example.com/data.json'),
      fetch('https://cdn2.example.com/data.json'),
      fetch('https://cdn3.example.com/data.json')
    ]).then(result => {
      console.log('æœ‰ä¸€ä¸ªæˆåŠŸå°±ç”¨äº†');
    }).catch(() => {
      console.error('éƒ½å¤±è´¥äº†');
    });
  ```

#### 3. Promiseé«˜çº§åº”ç”¨åœºæ™¯

ğŸ”¶ **å¹¶å‘æ§åˆ¶/Promiseå¹¶å‘æ± /é™æµ**
- æ¯”å¦‚:éœ€è¦ä¸Šä¼ 100ä¸ªæ–‡ä»¶ï¼Œä¸åº”è¯¥åŒæ—¶ä¸Šä¼ ï¼Œè€Œæ˜¯åˆ†æ‰¹ä¸Šä¼ ï¼Œæ¯æ¬¡ä¸Šä¼ ä¸€ç»„ï¼Œä¸Šä¼ å®Œä¸€ç»„å†ä¸Šä¼ ä¸‹ä¸€ç»„ï¼Œç›´åˆ°ä¸Šä¼ å®Œæ‰€æœ‰æ–‡ä»¶ã€‚

  ```js
    // æ‰‹å†™è¦ç‚¹æ€»ç»“ï¼š
    // 1. æ—¢ç„¶æœ‰concurrencyï¼Œé‚£å°±è¦æœ‰activeCountï¼Œå½“ activeCount < concurrency æ—¶ï¼Œå°±æ‰§è¡Œä»»åŠ¡
    // 2. éœ€è¦æœ‰ä¸‹æ ‡ cur æ¥è®°å½•å½“å‰æ‰§è¡Œåˆ°å“ªä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡çš„è¿”å›ç»“æœè¦åŸºäºä¸‹æ ‡æ¥å­˜å‚¨ï¼Œ ä¸èƒ½ç›´æ¥push

    function limitedPool(tasks, maxConcurrency = 4) {
      const results = []
      let cur = 0
      let activeCount = 0

      return new Promise((resolve, reject)=>{

        const runNext = ()=>{
          if(cur === tasks.length && activeCount === 0) return resolve(results)

          while(activeCount < maxConcurrency && cur < tasks.length){
            
            const curentIndex = cur++
            const task = tasks[curentIndex]

            activeCount++

            Promise.resolve(task())
              .then(res =>{
                results[curentIndex] = res
              })
              .catch(err=>{
                results[curentIndex] = err
              })
              .finally(()=>{
                activeCount--
                runNext()
              })
          }
        }
        runNext()
      })

    }

    const tasks = Array.from({ length: 10 }, (_, i) => () => fetch(`/api/${i}`));
    limitedPool(tasks, 3).then(res => console.log(res));



  ```


ğŸ”¶ **é‡è¯•æœºåˆ¶**
- æ¯”å¦‚: è¯·æ±‚æ¥å£å¤±è´¥ï¼Œè‡ªåŠ¨é‡è¯•ï¼Œé‡è¯•3æ¬¡ï¼Œå¦‚æœ3æ¬¡éƒ½å¤±è´¥ï¼Œåˆ™æ”¾å¼ƒã€‚

  ```js 
    function withRetry(fn, times) {

        return new Promise((resolve, reject) => {

            let count = 0
            const run = () => {

                Promise.resolve(fn()).then(res => {
                    resolve(res)
                }).catch(err => {

                    console.log('retry count:', count)
                    if (++count === times) reject(err)
                    run()
                })
            }

            run()
        })
    }

    const errFn = () => {
        return new Promise((resolve, reject) => {
            console.log('run fn')
            setTimeout(() => {
                reject('err')
            }, 1000);
        })
    }

    withRetry(errFn, 3).then((res) => console.log(res))

  ```

ğŸ”¶ **è¶…æ—¶å¤„ç†**
- æ¯”å¦‚: è¯·æ±‚æ¥å£è¶…æ—¶ï¼Œè‡ªåŠ¨æ”¾å¼ƒï¼Œè¶…æ—¶æ—¶é—´10ç§’ï¼Œå¦‚æœ10ç§’åè¿˜æ²¡è¿”å›ï¼Œåˆ™æ”¾å¼ƒ, è¿™é‡Œä¹‹å‰çš„Promise.race() å¯ä»¥å®ç°ï¼Œè¿™é‡Œå†æ’¸ä¸€é

  ```js
    function dontOutTime(fn, timeLimit) {
        return Promise.race([
            fn(),
            new Promise((_, reject) => setTimeout(() => reject(new Error('è¶…æ—¶Error')), timeLimit))
        ])
    }

    function func() {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                resolve(100)
            }, 999);
        })
    }

    dontOutTime(func, 1000)
        .then(res => console.log(res))
        .catch(err => console.log(err))

  ```



ğŸ”¶ **ä»»åŠ¡é˜Ÿåˆ—/ä¸²è¡Œ**
- æ¯”å¦‚ï¼šéœ€è¦å…ˆè¯·æ±‚æ¥å£Aï¼Œå†è¯·æ±‚æ¥å£Bï¼Œå†è¯·æ±‚æ¥å£C, è¿™ç§ç”¨async/await æœ€ç›´è§‚

  ```js
    async function apiA(){}
    async function apiB(){}
    async function apiC(){}

    async function main(){
      const resA = await apiA()
      const resB = await apiB()
      const resC = await apiC()
    }


  ```


## ä¸‰ã€Promiseæ‰‹å†™

è¦ç‚¹ï¼š
- PromiseåŸºæœ¬ç»“æ„
  - ç»´æŠ¤äº†ä¸€ä¸ªä¸å¯é€†çš„çŠ¶æ€`_status`ï¼šé»˜è®¤pendingã€æ”¹å˜æ—¶åªå¯èƒ½æ˜¯ `pending -> fulfilled`ã€`pending -> rejected`
  - ç»´æŠ¤äº†ä¸€ä¸ª`_value`ï¼Œç”¨äºå­˜å‚¨ç»“æœå€¼æˆ–é”™è¯¯ä¿¡æ¯
  - ç»´æŠ¤äº†ä¸€ä¸ª`_callbacks`ï¼Œç”¨äºå­˜å‚¨å›è°ƒå‡½æ•°ï¼Œéœ€è¦æ”¯æŒå¼‚æ­¥æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨setTimeoutæ¨¡æ‹Ÿå¼‚æ­¥
  - å¯¹äºä¼ å…¥çš„excutorå‡½æ•°çš„ç†è§£ï¼šPromise**å†…éƒ¨å®šä¹‰**äº†`resolve`å’Œ`reject`ä¸¤ä¸ªå‡½æ•°ï¼Œä¾›ç»™excutorå‡½æ•°è°ƒç”¨ï¼Œexcutorå‡½æ•°å†…éƒ¨è°ƒç”¨resolveæˆ–rejectï¼Œæ”¹å˜Promiseçš„çŠ¶æ€å’Œå€¼

- Promise.prototype.then
  - è¦æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œåˆ™éœ€è¦è¿”å›ä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡
  - è¿™ä¸ªæ–°çš„Promiseå¯¹è±¡åŸºäºçˆ¶äº²Promiseçš„`_status`å’Œ`_value`ï¼Œè°ƒç”¨handleæˆ–pushå›è°ƒå‡½æ•°

- Promise.prototype.catch
  - `return this.then(null, onRejected)`


```js
  function MyPromise(excutor) {
      this._status = 'pending'
      this._value = null
      this._callbacks = []

      const resolve = (val) => {
          if (this._status !== 'pending') return
          this._status = 'fulfilled'
          this._value = val

          setTimeout(() => { // æ¨¡æ‹Ÿå¼‚æ­¥
              this._callbacks.forEach(cb => cb.onFulfilled && cb.onFulfilled(val))
          })

      }

      const reject = (val) => {
          if (this._status !== 'pending') return
          this._status = 'rejected'
          this._value = val

          setTimeout(() => {
              this._callbacks.forEach(cb => cb.onRejected && cb.onRejected(val))
          });
      }

      try {
          excutor(resolve, reject)
      }
      catch (e) {
          reject(e)
      }
  }


  MyPromise.prototype.then = function (onFulfilled, onRejected) {

      // æ— æ³•æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œé“¾å¼è°ƒç”¨çš„æ ¸å¿ƒæ˜¯æŠŠç»“æœåŒ…è£…æˆæ–°Promiseå¹¶è¿”å›
      // if (this._status === 'fulfilled') {
      //     onFulfilled(this._value)
      // }
      // else if (this._status === 'rejected') {
      //     onRejected(this._value)
      // }
      // else {
      //     this._callbacks.push({
      //         onFulfilled, onRejected
      //     })
      // }

      const self = this // è¿™é‡Œçš„selfæ˜¯çˆ¶äº²promise

      // è¿”å›æ–°çš„ Promise å®ç°é“¾å¼è°ƒç”¨
      return new MyPromise((resolve, reject) => {
          function handle(callback) {
              try {
                  const result = callback(self._value)
                  resolve(result)
              } catch (error) {
                  reject(error)
              }
          }

          if (self._status === 'fulfilled') {
              handle(onFulfilled)
          } else if (self._status === 'rejected') {
              handle(onRejected)
          } else {
              self._callbacks.push({
                  onFulfilled: () => handle(onFulfilled),
                  onRejected: () => handle(onRejected)
              })
          }
      })
  }

  MyPromise.prototype.catch = function (onRejected) {
      return this.then(null, onRejected)
  }

  const promise = new MyPromise((resolve, reject) => {
      setTimeout(() => {
          resolve('OK!')
      }, 500);
  }).then((res) => {
      console.log('æ‹¿åˆ°', res)
      return '12313'
  }).then((res) => {
      console.log('åˆæ‹¿åˆ°', res)
  }).catch(e => {
      console.warn('æŠ¥é”™', e)
  })

```




















## å‚è€ƒèµ„æ–™

- [MDN Promise](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)



