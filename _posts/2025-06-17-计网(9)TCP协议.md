---
title: 'TCP协议-计网(9)'
date: 2025-06-17
permalink: /posts/network9/
tags:
  - 计算机网络

---
 
> TCP协议是互联网的基石，是互联网的灵魂。三次握手，四次挥手，流控，拥塞控制，是TCP协议的精髓。

---- 

## 目录

- [TCP收发数据的流程](#tcp收发数据的流程)
  - [1. 建立连接](#1-建立连接)
  - [2. 数据传输](#2-数据传输)
    - [分段发送](#分段发送)
    - [可靠传输](#可靠传输)
    - [拥塞控制](#拥塞控制)
  - [3. 断开连接](#3-断开连接)
    - [2MSL](#2msl)

- [思考](#思考)

## TCP收发数据的流程

回顾五层网络模型，TCP解决的是可靠传输的问题，如何保证可靠传输？

1. 建立连接：三次握手
2. 数据传输：流控，拥塞控制
3. 断开连接：四次挥手


### 1. 建立连接

连接的本质就是双方各自开辟一个Buffer，用于存储数据。
   
三次握手简单说：
- 客户端：我说话你能听见吗
- 服务端：能听见，那我说话你能听见吗
- 客户端：能听见

三次握手具体说：
- 客户端：**SYN=1**(同步序列编号)，seq=x
- 服务端：**SYN=1**(同步序列编号), **ACK=1**(确认编号)，seq=y，ack=x+1
- 客户端：**ACK=1**(确认编号)，seq=x+1，ack=y+1

![三次握手](/images/post-assets/3handshake.png){:style="width: 330px; display: block; margin: 0 auto;"}


### 2. 数据传输

#### 分段发送

HTTP中，传输的单位是**报文**，而TCP中，传输的单位是**报文段**。
TCP将HTTP报文拆分成多个报文段，每个报文段都有自己的**编号**和**校验和**，TCP会保证每个报文段都能到达目的地。

#### 可靠传输

在TCP协议中，为了保证数据不缺失(丢包)，数据不乱序、重复，TCP协议要求服务端在收到数据报时必须对数据报进行确认，如果服务端判定丢失/错误，会进行重传。

- 客户端：发送seq(数据报的编号)
- 服务端：收到seq，发送ACK(表示收到seq)和ack(表示收到seq后，下一个seq)
- 客户端：收到ACK后，发送下一个seq


#### 拥塞控制

拥塞控制是TCP协议中的一种机制，用于控制发送方发送数据的速度，防止接收方无法处理过多的数据。

---

**慢启动**
    
慢启动是拥塞控制的一种算法，初始化拥塞窗口(cwnd)为1个报文段，每收到一个ACK，拥塞窗口加1，每经过一个RTT，拥塞窗口加倍。
     
具体表现为，一开始发送速率很慢，传输的数据量很小，一段时间后，发送速率逐渐提高，传输速率达到峰值，网络带宽就会拉高

(网络带宽就是网络的传输速率，比如100M的带宽，就是100Mbps，即100Mb/s，即100Mb/s = 100/8 MB/s = 12.5MB/s。 注意`Mbps`是`Mbit/s`，不是`MB/s`)








### 3. 断开连接

四次挥手简单说：
- 客户端：我说完了，挂了?
- 服务端：稍等，我还要补充几点....
- 服务端：我说完了，挂了？
- 客户端：好的拜拜

四次挥手具体说：
- 客户端：**FIN=1**(结束标志)，seq=u
- 服务端：**ACK=1**(确认编号)，ack=u+1
- 服务端：**FIN=1**(结束标志)， **ACK=1**(确认编号)，seq=v，ack=u+1
- 客户端：**ACK=1**(确认编号)，ack=v+1


![四次挥手](/images/post-assets/4byebye.png){:style="width: 340px; display: block; margin: 0 auto;"}

#### 2MSL

2MSL，即2倍最大报文段生存时间(相当报文在两方来回一趟的时间)，是TCP协议中一个重要的概念。

在四次挥手的最后一步，客户端向服务端发送ACK报文，如果这个ACK报文丢失，服务端会重传FIN包，客户端需要保持连接状态足够长时间来接收这个重传的FIN包，所以需要等待2MSL。


## 思考

1. 为什么TCP协议是可靠的？
1. 讲讲三次握手
2. 讲讲四次挥手
3. 讲讲四次挥手中2MSL的作用（TIME_WAIT状态的作用）
5. HTTP和TCP的区别和联系是什么？
   - HTTP是应用层协议，做的是消息格式的规定
   - TCP是传输层协议，负责消息的可靠传输
   - HTTP是基于TCP的，一次HTTP请求-响应过程，包括建立连接、完成请求和响应、断开连接，所以说HTTP请求是无状态的